# 架构概览

L8 IM Android SDK 采用模块化设计，提供完整的即时通讯能力。

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层 (App)                          │
├─────────────────────────────────────────────────────────────┤
│                      WKIM (SDK 入口)                         │
├──────────┬──────────┬──────────┬──────────┬────────────────┤
│   Msg    │  Conn    │ Channel  │  Conv    │    Members     │
│ Manager  │ Manager  │ Manager  │ Manager  │    Manager     │
├──────────┴──────────┴──────────┴──────────┴────────────────┤
│                     消息处理层 (Message)                      │
│              WKConnection / MessageHandler                   │
├─────────────────────────────────────────────────────────────┤
│                     数据存储层 (Database)                     │
│                    SQLCipher 加密数据库                       │
├─────────────────────────────────────────────────────────────┤
│                     协议层 (Protocol)                         │
│              WebSocket / 自定义 IM 协议                       │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. WKIM - SDK 入口

单例模式，提供 SDK 初始化和各管理器的访问入口。

**职责：**
- SDK 初始化和配置
- 管理器实例获取
- 全局状态管理

### 2. ConnectionManager - 连接管理

管理与 IM 服务器的 WebSocket 连接。

**职责：**
- 连接建立与断开
- 连接状态监听
- 自动重连机制
- 心跳保活

### 3. MsgManager - 消息管理

处理消息的发送、接收、存储和查询。

**职责：**
- 消息发送与接收
- 消息本地存储
- 消息同步
- 自定义消息注册
- 附件上传管理

### 4. ConversationManager - 会话管理

管理会话列表和会话状态。

**职责：**
- 会话列表维护
- 未读消息计数
- 会话同步
- 会话删除与清空

### 5. ChannelManager - 频道管理

管理频道（聊天对象）信息。

**职责：**
- 频道信息缓存
- 频道属性更新
- 频道搜索

### 6. ChannelMembersManager - 成员管理

管理群组频道的成员信息。

**职责：**
- 成员列表管理
- 成员信息更新
- 成员角色管理

---

## 数据流

### 发送消息流程

```
App 调用 send()
       │
       ▼
┌─────────────────┐
│   MsgManager    │ ─── 创建 WKMsg 对象
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ MessageHandler  │ ─── 消息入队、附件上传
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  WKConnection   │ ─── 编码并发送
└────────┬────────┘
         │
         ▼
    IM Server
```

### 接收消息流程

```
    IM Server
         │
         ▼
┌─────────────────┐
│  WKConnection   │ ─── 接收并解码
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ MessageHandler  │ ─── 消息解析、存储
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   MsgManager    │ ─── 触发监听回调
└────────┬────────┘
         │
         ▼
    App 回调
```

---

## 数据存储

SDK 使用 **SQLCipher** 加密数据库存储本地数据。

### 主要数据表

| 表名 | 说明 |
|------|------|
| `message` | 消息记录 |
| `conversation` | 会话列表 |
| `channel` | 频道信息 |
| `channel_member` | 频道成员 |
| `msg_reaction` | 消息回应 |
| `reminder` | 提醒信息 |

---

## 线程模型

- **主线程**: UI 回调、事件通知
- **IO 线程**: 网络通信、数据库操作
- **消息队列**: 消息发送队列管理

所有监听回调都在主线程执行，可直接更新 UI。

---

## 下一步

- [快速入门](QUICK_START.md) - 快速集成指南
- [API 参考](API_REFERENCE.md) - 完整 API 文档

